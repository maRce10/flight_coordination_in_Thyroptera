rm(list = ls())
# unload all non-based packages
out <- sapply(paste('package:', names(sessionInfo()$otherPkgs), sep = ""), function(x) try(detach(x, unload = FALSE, character.only = TRUE), silent = T))
## add 'developer/' to packages to be installed from github
x <- c("warbleR", "bioacoustics", "pbapply", "Rraven", "parallel", "viridis")
aa <- lapply(x, function(y) {
# get pakage name
pkg <- strsplit(y, "/")[[1]]
pkg <- pkg[length(pkg)]
# check if installed, if not then install
if (!pkg %in% installed.packages()[,"Package"])  {
if (grepl("/", y))  devtools::install_github(y, force = TRUE) else
install.packages(y)
}
# load package
try(require(pkg, character.only = T), silent = T)
})
warbleR_options(wav.path = "/media/m/Seagate Expansion Drive/Proyecto MPI/Enero 2020/audios", wl = 300, parallel = parallel::detectCores() - 1, bp = "frange", fast = F, threshold = 15, ovlp = 90)
# wav_info()
fix_wavs(samp.rate = 80, bit.depth = 16, sox = TRUE)
warbleR_options(wav.path = "/media/m/Seagate Expansion Drive/Proyecto MPI/Enero 2020/audios", wl = 300, parallel = parallel::detectCores() - 1, bp = "frange", fast = F, threshold = 15, ovlp = 90)
fix_wavs(samp.rate = 80, bit.depth = 16, sox = TRUE)
wav_info()
setwd("/media/m/Seagate Expansion Drive/Proyecto MPI/Enero 2020/audios")
fix_wavs(samp.rate = 80, bit.depth = 16, sox = TRUE)
# unset github credentials
Sys.unsetenv("GITHUB_PAT")
## add 'developer/' to packages to be installed from github
x <- c("devtools", "maRce10/warbleR", "bioacoustics", "pbapply", "Rraven", "parallel", "viridis")
aa <- lapply(x, function(y) {
# get pakage name
pkg <- strsplit(y, "/")[[1]]
pkg <- pkg[length(pkg)]
# check if installed, if not then install
if (!pkg %in% installed.packages()[,"Package"])  {
if (grepl("/", y))  devtools::install_github(y, force = TRUE) else
install.packages(y)
}
# load package
try(require(pkg, character.only = T), silent = T)
})
warbleR_options(wav.path = "/home/m/Documentos/Github_projects/flight_coordination_thyroptera/data/raw/resample_80kHz", wl = 300, parallel = parallel::detectCores() - 1, bp = "frange", fast = F, threshold = 15, ovlp = 90)
# wav_info()
# plit in segments of 30 s without saving clips
split_sels <- split_wavs(only.sels = TRUE, sgmt.dur = 30)
# relabels sels to make it and regular selection table
split_sels$selec <- 1:nrow(split_sels)
split_sels$sound.files <- split_sels$org.sound.files
split_sels$org.sound.files <- NULL
# check
cs <- check_sels(split_sels)
# get template
inq_est <- readRDS("/home/m/sda5/Dropbox/Projects/Ontogenia respuesta Thyroptera/suppl_mat/ext_sel_tab_inquiry.RDS")
# get mean duration one
inq_est <- sig2noise(inq_est, mar = 0.01)
inq_est <- inq_est[inq_est$SNR > quantile(inq_est$SNR, 0.75), ]
inq_est$dur <- inq_est$end - inq_est$start
template <- inq_est[which.min(abs(inq_est$dur - mean(inq_est$dur))),, drop = FALSE]
template <- resample_est(template, samp.rate = 80, bit.depth = 16)
temp_st <- exp_est(template, selection.table = FALSE)
temp_st$type <- "template"
split_sels$type <- NA
split_sels$top.freq <- 35
split_sels$bottom.freq <- 10
temp_st <- temp_st[, names(split_sels)]
split_sels_detec <- rbind(temp_st, split_sels)
comp_mat <- cbind(paste(split_sels_detec$sound.files[1], split_sels_detec$selec[1], sep = "-"), paste(split_sels$sound.files, split_sels$selec, sep = "-"))
sq_rws <- seq(1, nrow(split_sels_detec), by = 4)
sq_rws <- c(sq_rws, nrow(split_sels_detec))
# loop over rows
pks_l <- lapply(2:length(sq_rws), function(x){
# get progress
print(round(x / length(sq_rws), 2))
# cross correlation
xc.output <- xcorr(
X = split_sels_detec[c(1, sq_rws[x - 1]:sq_rws[x] + 1), ], output = "list",
compare.matrix = comp_mat[sq_rws[x - 1]:sq_rws[x], ],
pb = FALSE, bp = "pairwise.freq.range",
path = "/home/m/Documentos/Github_projects/flight_coordination_thyroptera/data/raw/resample_80kHz",
wl = 300, ovlp = 0)
# find peaks
pks <- find_peaks(xc.output = xc.output, pb = FALSE, cutoff = 0.3)
return(pks)
})
# plit in segments of 30 s without saving clips
split_sels <- split_wavs(only.sels = TRUE, sgmt.dur = 30)
# relabels sels to make it and regular selection table
split_sels$selec <- 1:nrow(split_sels)
split_sels$sound.files <- split_sels$org.sound.files
split_sels$org.sound.files <- NULL
# do subset
split_sels[1:100, ]
# check
cs <- check_sels(split_sels)
# get template
inq_est <- readRDS("/home/m/sda5/Dropbox/Projects/Ontogenia respuesta Thyroptera/suppl_mat/ext_sel_tab_inquiry.RDS")
# get mean duration one
inq_est <- sig2noise(inq_est, mar = 0.01)
inq_est <- inq_est[inq_est$SNR > quantile(inq_est$SNR, 0.75), ]
inq_est$dur <- inq_est$end - inq_est$start
template <- inq_est[which.min(abs(inq_est$dur - mean(inq_est$dur))),, drop = FALSE]
template <- resample_est(template, samp.rate = 80, bit.depth = 16)
temp_st <- exp_est(template, selection.table = FALSE)
temp_st$type <- "template"
split_sels$type <- NA
split_sels$top.freq <- 35
split_sels$bottom.freq <- 10
temp_st <- temp_st[, names(split_sels)]
split_sels_detec <- rbind(temp_st, split_sels)
comp_mat <- cbind(paste(split_sels_detec$sound.files[1], split_sels_detec$selec[1], sep = "-"), paste(split_sels$sound.files, split_sels$selec, sep = "-"))
sq_rws <- seq(1, nrow(split_sels_detec), by = 4)
sq_rws <- c(sq_rws, nrow(split_sels_detec))
# loop over rows
pks_l <- lapply(2:length(sq_rws), function(x){
# get progress
print(round(x / length(sq_rws), 2))
# cross correlation
xc.output <- xcorr(
X = split_sels_detec[c(1, sq_rws[x - 1]:sq_rws[x] + 1), ], output = "list",
compare.matrix = comp_mat[sq_rws[x - 1]:sq_rws[x], ],
pb = FALSE, bp = "pairwise.freq.range",
path = "/home/m/Documentos/Github_projects/flight_coordination_thyroptera/data/raw/resample_80kHz",
wl = 300, ovlp = 0)
# find peaks
pks <- find_peaks(xc.output = xc.output, pb = FALSE, cutoff = 0.1)
return(pks)
})
# plit in segments of 30 s without saving clips
split_sels <- split_wavs(only.sels = TRUE, sgmt.dur = 30)
# relabels sels to make it and regular selection table
split_sels$selec <- 1:nrow(split_sels)
split_sels$sound.files <- split_sels$org.sound.files
split_sels$org.sound.files <- NULL
# do subset
split_sels <- split_sels[1:100, ]
# check
cs <- check_sels(split_sels)
# get template
inq_est <- readRDS("/home/m/sda5/Dropbox/Projects/Ontogenia respuesta Thyroptera/suppl_mat/ext_sel_tab_inquiry.RDS")
# get mean duration one
inq_est <- sig2noise(inq_est, mar = 0.01)
inq_est <- inq_est[inq_est$SNR > quantile(inq_est$SNR, 0.75), ]
inq_est$dur <- inq_est$end - inq_est$start
template <- inq_est[which.min(abs(inq_est$dur - mean(inq_est$dur))),, drop = FALSE]
template <- resample_est(template, samp.rate = 80, bit.depth = 16)
temp_st <- exp_est(template, selection.table = FALSE)
temp_st$type <- "template"
split_sels$type <- NA
split_sels$top.freq <- 35
split_sels$bottom.freq <- 10
temp_st <- temp_st[, names(split_sels)]
split_sels_detec <- rbind(temp_st, split_sels)
comp_mat <- cbind(paste(split_sels_detec$sound.files[1], split_sels_detec$selec[1], sep = "-"), paste(split_sels$sound.files, split_sels$selec, sep = "-"))
sq_rws <- seq(1, nrow(split_sels_detec), by = 4)
sq_rws <- c(sq_rws, nrow(split_sels_detec))
# loop over rows
pks_l <- lapply(2:length(sq_rws), function(x){
# get progress
print(round(x / length(sq_rws), 2))
# cross correlation
xc.output <- xcorr(
X = split_sels_detec[c(1, sq_rws[x - 1]:sq_rws[x] + 1), ], output = "list",
compare.matrix = comp_mat[sq_rws[x - 1]:sq_rws[x], ],
pb = FALSE, bp = "pairwise.freq.range",
path = "/home/m/Documentos/Github_projects/flight_coordination_thyroptera/data/raw/resample_80kHz",
wl = 300, ovlp = 0)
# find peaks
pks <- find_peaks(xc.output = xc.output, pb = FALSE, cutoff = 0.1)
return(pks)
})
# exclude non-detected
pks <- pks[!is.na(pks$start), ]
# get frequency range
fr_pks <- freq_range(X = pks, bp = c(8, 70), fsmooth = 0.001, ovlp = 90,
threshold = 5, img = FALSE)
fr_pks$bottom.freq[is.na(fr_pks$bottom.freq)] <- mean(fr_pks$bottom.freq, na.rm = TRUE)
fr_pks$top.freq[is.na(fr_pks$top.freq)] <- mean(fr_pks$top.freq, na.rm = TRUE)
write.csv(fr_pks, "./data/processed/cross-correlation_detections_inquiry_calls.csv", row.names = FALSE)
# Export raven selection tables
st <- selection_table(whole.recs = TRUE)
st$end <- 0.01
st$bottom.freq <- 10
st$top.freq <- 12
st$channel <- NULL
ad2 <- rbind(as.data.frame(st), fr_pks)
exp_raven(X = ad2, file.name = "./data/processed/cross-correlation_detections_inquiry_calls_Raven_format.txt", sound.file.path =  .Options$warbleR$wav.path)
# plit in segments of 30 s without saving clips
split_sels <- split_wavs(only.sels = TRUE, sgmt.dur = 30)
# relabels sels to make it and regular selection table
split_sels$selec <- 1:nrow(split_sels)
split_sels$sound.files <- split_sels$org.sound.files
split_sels$org.sound.files <- NULL
# do subset
split_sels <- split_sels[1:100, ]
# check
cs <- check_sels(split_sels)
# get template
inq_est <- readRDS("/home/m/sda5/Dropbox/Projects/Ontogenia respuesta Thyroptera/suppl_mat/ext_sel_tab_inquiry.RDS")
# get mean duration one
inq_est <- sig2noise(inq_est, mar = 0.01)
inq_est <- inq_est[inq_est$SNR > quantile(inq_est$SNR, 0.75), ]
inq_est$dur <- inq_est$end - inq_est$start
template <- inq_est[which.min(abs(inq_est$dur - mean(inq_est$dur))),, drop = FALSE]
template <- resample_est(template, samp.rate = 80, bit.depth = 16)
temp_st <- exp_est(template, selection.table = FALSE)
temp_st$type <- "template"
split_sels$type <- NA
split_sels$top.freq <- 35
split_sels$bottom.freq <- 10
temp_st <- temp_st[, names(split_sels)]
split_sels_detec <- rbind(temp_st, split_sels)
comp_mat <- cbind(paste(split_sels_detec$sound.files[1], split_sels_detec$selec[1], sep = "-"), paste(split_sels$sound.files, split_sels$selec, sep = "-"))
sq_rws <- seq(1, nrow(split_sels_detec), by = 4)
# sq_rws <- c(sq_rws, nrow(split_sels_detec))
# loop over rows
pks_l <- lapply(2:length(sq_rws), function(x){
# get progress
print(round(x / length(sq_rws), 2))
# cross correlation
xc.output <- xcorr(
X = split_sels_detec[c(1, sq_rws[x - 1]:sq_rws[x] + 1), ], output = "list",
compare.matrix = comp_mat[sq_rws[x - 1]:sq_rws[x], ],
pb = FALSE, bp = "pairwise.freq.range",
path = "/home/m/Documentos/Github_projects/flight_coordination_thyroptera/data/raw/resample_80kHz",
wl = 300, ovlp = 0)
# find peaks
pks <- find_peaks(xc.output = xc.output, pb = FALSE, cutoff = 0.1)
return(pks)
})
# exclude non-detected
pks <- pks[!is.na(pks$start), ]
# get frequency range
fr_pks <- freq_range(X = pks, bp = c(8, 70), fsmooth = 0.001, ovlp = 90,
threshold = 5, img = FALSE)
fr_pks$bottom.freq[is.na(fr_pks$bottom.freq)] <- mean(fr_pks$bottom.freq, na.rm = TRUE)
fr_pks$top.freq[is.na(fr_pks$top.freq)] <- mean(fr_pks$top.freq, na.rm = TRUE)
write.csv(fr_pks, "./data/processed/cross-correlation_detections_inquiry_calls.csv", row.names = FALSE)
# Export raven selection tables
st <- selection_table(whole.recs = TRUE)
st$end <- 0.01
st$bottom.freq <- 10
st$top.freq <- 12
st$channel <- NULL
ad2 <- rbind(as.data.frame(st), fr_pks)
exp_raven(X = ad2, file.name = "./data/processed/cross-correlation_detections_inquiry_calls_Raven_format.txt", sound.file.path =  .Options$warbleR$wav.path)
sq_rws
# plit in segments of 30 s without saving clips
split_sels <- split_wavs(only.sels = TRUE, sgmt.dur = 30)
# relabels sels to make it and regular selection table
split_sels$selec <- 1:nrow(split_sels)
split_sels$sound.files <- split_sels$org.sound.files
split_sels$org.sound.files <- NULL
# do subset
split_sels <- split_sels[1:100, ]
# check
cs <- check_sels(split_sels)
# get template
inq_est <- readRDS("/home/m/sda5/Dropbox/Projects/Ontogenia respuesta Thyroptera/suppl_mat/ext_sel_tab_inquiry.RDS")
# get mean duration one
inq_est <- sig2noise(inq_est, mar = 0.01)
inq_est <- inq_est[inq_est$SNR > quantile(inq_est$SNR, 0.75), ]
inq_est$dur <- inq_est$end - inq_est$start
template <- inq_est[which.min(abs(inq_est$dur - mean(inq_est$dur))),, drop = FALSE]
template <- resample_est(template, samp.rate = 80, bit.depth = 16)
temp_st <- exp_est(template, selection.table = FALSE)
temp_st$type <- "template"
split_sels$type <- NA
split_sels$top.freq <- 35
split_sels$bottom.freq <- 10
temp_st <- temp_st[, names(split_sels)]
split_sels_detec <- rbind(temp_st, split_sels)
comp_mat <- cbind(paste(split_sels_detec$sound.files[1], split_sels_detec$selec[1], sep = "-"), paste(split_sels$sound.files, split_sels$selec, sep = "-"))
sq_rws <- seq(1, nrow(split_sels), by = 4)
sq_rws <- c(sq_rws, nrow(split_sels))
# loop over rows
pks_l <- lapply(2:length(sq_rws), function(x){
# get progress
print(round(x / length(sq_rws), 2))
# cross correlation
xc.output <- xcorr(
X = split_sels_detec[c(1, sq_rws[x - 1]:sq_rws[x] + 1), ], output = "list",
compare.matrix = comp_mat[sq_rws[x - 1]:sq_rws[x], ],
pb = FALSE, bp = "pairwise.freq.range",
path = "/home/m/Documentos/Github_projects/flight_coordination_thyroptera/data/raw/resample_80kHz",
wl = 300, ovlp = 0)
# find peaks
pks <- find_peaks(xc.output = xc.output, pb = FALSE, cutoff = 0.1)
return(pks)
})
# exclude non-detected
pks <- pks[!is.na(pks$start), ]
# get frequency range
fr_pks <- freq_range(X = pks, bp = c(8, 70), fsmooth = 0.001, ovlp = 90,
threshold = 5, img = FALSE)
fr_pks$bottom.freq[is.na(fr_pks$bottom.freq)] <- mean(fr_pks$bottom.freq, na.rm = TRUE)
fr_pks$top.freq[is.na(fr_pks$top.freq)] <- mean(fr_pks$top.freq, na.rm = TRUE)
write.csv(fr_pks, "./data/processed/cross-correlation_detections_inquiry_calls.csv", row.names = FALSE)
# Export raven selection tables
st <- selection_table(whole.recs = TRUE)
pks <- do.call(rbind, pks_l)
# exclude non-detected
pks <- pks[!is.na(pks$start), ]
pks
# get frequency range
fr_pks <- freq_range(X = pks, bp = c(8, 70), fsmooth = 0.001, ovlp = 90,
threshold = 5, img = FALSE)
fr_pks$bottom.freq[is.na(fr_pks$bottom.freq)] <- mean(fr_pks$bottom.freq, na.rm = TRUE)
fr_pks$top.freq[is.na(fr_pks$top.freq)] <- mean(fr_pks$top.freq, na.rm = TRUE)
exp_raven(X = fr_pks, file.name = "./data/processed/cross-correlation_detections_inquiry_calls_Raven_format.txt", sound.file.path =  .Options$warbleR$wav.path)
