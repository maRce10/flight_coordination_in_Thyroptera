---
title: <center><font size="6"><b>Acoustic analysis inquiry calls</b></font></center>
subtitle: <center><font size="4"><b>Group flight coordination in Thyroptera</b></font></center>
author: <center><font size="4"><a href="http://marceloarayasalas.weebly.com/">Marcelo Araya-Salas, PhD</a></font></center>
date: <center>`r format(Sys.Date(), "%d-%m-%Y")`</center>
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
      smooth_scroll: no
fontsize: 12pt 
editor_options: 
  chunk_output_type: console
---

```{r packages, message = FALSE, warning = FALSE, echo = FALSE, eval = TRUE, include = FALSE}

# unset github credentials
Sys.unsetenv("GITHUB_PAT")

## add 'developer/' to packages to be installed from github
x <- c("devtools", "maRce10/warbleR", "bioacoustics", "pbapply", "Rraven", "parallel", "viridis")

aa <- lapply(x, function(y) {
  
  # get pakage name
  pkg <- strsplit(y, "/")[[1]]
  pkg <- pkg[length(pkg)]
  
  # check if installed, if not then install 
  if (!pkg %in% installed.packages()[,"Package"])  {

      if (grepl("/", y))  devtools::install_github(y, force = TRUE) else
    install.packages(y) 
    }

  # load package
  try(require(pkg, character.only = T), silent = T)
})

```

```{r functions, eval = TRUE, echo = FALSE}

warbleR_options(wav.path = "/home/m/Documentos/Github_projects/flight_coordination_thyroptera/data/raw/resample_80kHz", wl = 300, parallel = parallel::detectCores() - 1, bp = "frange", fast = F, threshold = 15, ovlp = 20)

# wav_info()

```

```{r autodetec, eval = FALSE}

# setwd("/media/m/Seagate Expansion Drive/Proyecto MPI/Enero 2020/audios")
# 
# fix_wavs(samp.rate = 80, bit.depth = 16, sox = TRUE)

# plit in segments of 30 s without saving clips
split_sels <- split_wavs(only.sels = TRUE, sgmt.dur = 30)

# relabels sels to make it and regular selection table
split_sels$selec <- 1:nrow(split_sels)
split_sels$sound.files <- split_sels$org.sound.files
split_sels$org.sound.files <- NULL

# check
cs <- check_sels(split_sels)

# get template
# inq_est <- readRDS("/home/m/sda5/Dropbox/Projects/Ontogenia respuesta Thyroptera/suppl_mat/ext_sel_tab_inquiry.RDS")

# get mean duration one
# inq_est <- sig2noise(inq_est, mar = 0.01)
# 
# inq_est <- inq_est[inq_est$SNR > quantile(inq_est$SNR, 0.75), ]
# 
# inq_est$dur <- inq_est$end - inq_est$start
# 
# template <- inq_est[which.min(abs(inq_est$dur - mean(inq_est$dur))),, drop = FALSE]
# 
# template <- resample_est(template, samp.rate = 80, bit.depth = 16)
# 
# temp_st <- exp_est(template, selection.table = FALSE)
# 
# temp_st$type <- "template"
# split_sels$type <- NA
# split_sels$top.freq <- 35
# split_sels$bottom.freq <- 10

# temp_st <- temp_st[, names(split_sels)]

# split_sels_detec <- rbind(temp_st, split_sels)
# 
# comp_mat <- cbind(paste(split_sels_detec$sound.files[1], split_sels_detec$selec[1], sep = "-"), paste(split_sels$sound.files, split_sels$selec, sep = "-"))
# 
# 
# 
# 
# nrow(comp_mat)
# nrow(split_sels_detec)


# autodetec
ad <- autodetec(X = split_sels, threshold = 4, mindur= 0.02, maxdur = 0.07, bp = c(10, 35), img = FALSE, ssmooth = 400, parallel = 2)

# save non-detected
no_dtct <- ad[is.na(ad$start), ]

# exclude non-detected
ad <- ad[!is.na(ad$start), ]

# get frequency range
fr_ad <- freq_range(X = ad, bp = c(8, 70), fsmooth = 0.001, ovlp = 90,
                          threshold = 5, img = FALSE)

fr_ad$bottom.freq[is.na(fr_ad$bottom.freq)] <- mean(fr_ad$bottom.freq, na.rm = TRUE)
fr_ad$top.freq[is.na(fr_ad$top.freq)] <- mean(fr_ad$top.freq, na.rm = TRUE)

write.csv(fr_ad, "./data/processed/automatic_detections_inquiry_calls.csv", row.names = FALSE)

# Export raven selection tables
st <- selection_table(whole.recs = TRUE)

st$end <- 0.01
st$bottom.freq <- 10
st$top.freq <- 12
st$channel <- NULL

ad2 <- rbind(as.data.frame(st), fr_ad)

exp_raven(X = ad2, file.name = "./data/processed/automatic_detections_inquiry_calls_Raven_format.txt", sound.file.path =  .Options$warbleR$wav.path)



```

```{r cross-correlation, eval = FALSE}

# plit in segments of 30 s without saving clips
split_sels <- split_wavs(only.sels = TRUE, sgmt.dur = 30)

# relabels sels to make it and regular selection table
split_sels$selec <- 1:nrow(split_sels)
split_sels$sound.files <- split_sels$org.sound.files
split_sels$org.sound.files <- NULL


# do subset
split_sels <- split_sels[1:100, ]

# check
cs <- check_sels(split_sels)

# get template
inq_est <- readRDS("/home/m/sda5/Dropbox/Projects/Ontogenia respuesta Thyroptera/suppl_mat/ext_sel_tab_inquiry.RDS")

# get mean duration one
inq_est <- sig2noise(inq_est, mar = 0.01)

inq_est <- inq_est[inq_est$SNR > quantile(inq_est$SNR, 0.75), ]

inq_est$dur <- inq_est$end - inq_est$start

template <- inq_est[which.min(abs(inq_est$dur - mean(inq_est$dur))),, drop = FALSE]

template <- resample_est(template, samp.rate = 80, bit.depth = 16)

temp_st <- exp_est(template, selection.table = FALSE)

temp_st$type <- "template"
split_sels$type <- NA
split_sels$top.freq <- 35
split_sels$bottom.freq <- 10

temp_st <- temp_st[, names(split_sels)]

split_sels_detec <- rbind(temp_st, split_sels)

comp_mat <- cbind(paste(split_sels_detec$sound.files[1], split_sels_detec$selec[1], sep = "-"), paste(split_sels$sound.files, split_sels$selec, sep = "-"))

sq_rws <- seq(1, nrow(split_sels), by = 4)

sq_rws <- c(sq_rws, nrow(split_sels))

# loop over rows
pks_l <- lapply(2:length(sq_rws), function(x){
  
  # get progress
  print(round(x / length(sq_rws), 2))

    # cross correlation
  xc.output <- xcorr(
  X = split_sels_detec[c(1, sq_rws[x - 1]:sq_rws[x] + 1), ], output = "list",
  compare.matrix = comp_mat[sq_rws[x - 1]:sq_rws[x], ], 
  pb = FALSE, bp = "pairwise.freq.range",
  path = "/home/m/Documentos/Github_projects/flight_coordination_thyroptera/data/raw/resample_80kHz", 
  wl = 300, ovlp = 0)
  
  # find peaks
  pks <- find_peaks(xc.output = xc.output, pb = FALSE, cutoff = 0.1)
  
  return(pks)
  })


pks <- do.call(rbind, pks_l)

# exclude non-detected
pks <- pks[!is.na(pks$start), ]

# get frequency range
fr_pks <- freq_range(X = pks, bp = c(8, 70), fsmooth = 0.001, ovlp = 90,
                          threshold = 5, img = FALSE)

fr_pks$bottom.freq[is.na(fr_pks$bottom.freq)] <- mean(fr_pks$bottom.freq, na.rm = TRUE)
fr_pks$top.freq[is.na(fr_pks$top.freq)] <- mean(fr_pks$top.freq, na.rm = TRUE)

write.csv(fr_pks, "./data/processed/cross-correlation_detections_inquiry_calls.csv", row.names = FALSE)

# Export raven selection tables
st <- selection_table(whole.recs = TRUE)

st$end <- 0.01
st$bottom.freq <- 10
st$top.freq <- 12
st$channel <- NULL

ad2 <- rbind(as.data.frame(st), fr_pks)

exp_raven(X = ad2, file.name = "./data/processed/cross-correlation_detections_inquiry_calls_Raven_format.txt", sound.file.path =  .Options$warbleR$wav.path)



```



```{r}


splsls <- split_sels_detec[split_sels_detec$sound.files == "ch1MPI_2020-01-30_12-52-01_0000190.wav" | !is.na(split_sels_detec$type), ]



comp_mat_sub <- comp_mat[grep("ch1MPI_2020-01-30_12-52-01_0000190.wav", comp_mat[, 2]), ]

xc.output <- x_corr(X = splsls, output = "list",
    compare.matrix = comp_mat_sub, pb = TRUE, parallel = 1)

# find peaks
pks <- find_peaks(xc.output = xc.output, pb = TRUE)

pks$bottom.freq <- lbh_selec_table$bottom.freq[1]
pks$top.freq <- lbh_selec_table$top.freq[1]



adX <- autodetec(X = splsls, threshold = 4, mindur= 0.02, maxdur = 0.07, bp = c(10, 35), img = FALSE, ssmooth = 400, parallel = 1)

adX


wi <- wav_info()

split_wavs()


```

